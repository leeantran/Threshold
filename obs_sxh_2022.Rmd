---
title: "Phân tích dữ liệu SXH đợt dịch 2022"
output:
  word_document: default
  html_document:
    df_print: paged
    fig_print: paged
message: false
warning: false
echo: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(readxl)
library(tidyverse)
library(ggplot2)
library(surveillance)
library(lubridate)
library(mem)

# ewma <- function(data, total_column, year_column, week_column, lambda, year_to_predict, k = 2) {
# 
#   training_data <- data %>% filter(!!sym(year_column) < year_to_predict)
#   
# 
#   training_data <- training_data %>%
#     group_by(!!sym(week_column)) %>%
#     mutate(
#       ewma = accumulate(
#         .x = !!sym(total_column),
#         .f = ~ lambda * .x + (1 - lambda) * .y,
#         .init = first(!!sym(total_column))
#       )[-1]
#     ) %>%
#     ungroup()
#   
# 
#   week_stats <- training_data %>%
#     group_by(!!sym(week_column)) %>%
#     summarise(
#       mean_ewma = mean(ewma, na.rm = TRUE),
#       sd_ewma = sd(ewma, na.rm = TRUE),
#       upper_bound = mean_ewma + k * sd_ewma,
#       .groups = "drop"
#     )
#   
# 
#   prediction_data <- data %>% filter(!!sym(year_column) == year_to_predict)
#   
#   
#   prediction_data <- prediction_data %>%
#     left_join(week_stats, by = setNames("tuan", week_column)) %>%
#     mutate(
#       outbreak_ewma = ifelse(!!sym(total_column) > upper_bound, 1, 0)
#     )
#   
#   
#   result <- bind_rows(
#     training_data %>% select(-ewma),
#     prediction_data
#   )
#   
#   return(result)
# }
```

## Thành phố

```{r}
df_raw <- read_xlsx("Data/data_raw.xlsx", sheet = "sxh")

df_raw$total[df_raw$nam == 2019] <- df_raw$mean[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$mean[df_raw$nam == 2021] 

df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")

# Không sử dụng được RKI3 vì range quá ngắn, tức là muốn đánh giá năm dịch là năm 2019 nhưng rki3 thì cần số liệu của năm trước năm có địch để tham chiếu 
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp MEM

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "MEM", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_tp_sxh_2022.rds")
```

## Quận/Huyện

## QUẬN 1

```{r}
df_raw$total <- df_raw$q1
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q1[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q1[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q1
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# MEM
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q1_sxh_2022.rds")
```

## QUẬN 3

```{r}
df_raw$total <- df_raw$q3
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q3[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q3[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q3
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q3_sxh_2022.rds")
```

## QUẬN 4

```{r}
df_raw$total <- df_raw$q4
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q4[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q4[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q4
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)
predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q4_sxh_2022.rds")
```

## QUẬN 5

```{r}
df_raw$total <- df_raw$q5
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q5[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q5[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q5
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q5_sxh_2022.rds")
```

## QUẬN 6

```{r}
df_raw$total <- df_raw$q6
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q6[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q6[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q6
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q6_sxh_2022.rds")
```

## QUẬN 7

```{r}
df_raw$total <- df_raw$q7
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q7[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q7[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q7
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q7_sxh_2022.rds")
```

## QUẬN 8

```{r}
df_raw$total <- df_raw$q8
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q8[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q8[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q8
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q8_sxh_2022.rds")
```

## QUẬN 10

```{r}
df_raw$total <- df_raw$q10
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q10[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q10[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q10
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q10_sxh_2022.rds")
```

## QUẬN 11

```{r}
df_raw$total <- df_raw$q11
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q11[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q11[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q11
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q11_sxh_2022.rds")
```

## QUẬN 12

```{r}
df_raw$total <- df_raw$q12
df_raw$total[df_raw$nam == 2019] <- df_raw$m_q12[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_q12[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_q12
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_q12_sxh_2022.rds")
```

## GV

```{r}
df_raw$total <- df_raw$gv
df_raw$total[df_raw$nam == 2019] <- df_raw$m_gv[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_gv[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_gv
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_gv_sxh_2022.rds")
```

## TB

```{r}
df_raw$total <- df_raw$tb
df_raw$total[df_raw$nam == 2019] <- df_raw$m_tb[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_tb[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_tb
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_tb_sxh_2022.rds")
```

## BT

```{r}
df_raw$total <- df_raw$bt
df_raw$total[df_raw$nam == 2019] <- df_raw$m_bt[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_bt[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_bt
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_bt_sxh_2022.rds")
```

## PN

```{r}
df_raw$total <- df_raw$pn
df_raw$total[df_raw$nam == 2019] <- df_raw$m_pn[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_pn[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_pn
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_pn_sxh_2022.rds")
```

## CC

```{r}
df_raw$total <- df_raw$cc
df_raw$total[df_raw$nam == 2019] <- df_raw$m_cc[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_cc[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_cc
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_cc_sxh_2022.rds")
```

## HM

```{r}
df_raw$total <- df_raw$hm
df_raw$total[df_raw$nam == 2019] <- df_raw$m_hm[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_hm[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_hm
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_hm_sxh_2022.rds")
```

## BC

```{r}
df_raw$total <- df_raw$bc
df_raw$total[df_raw$nam == 2019] <- df_raw$m_bc[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_bc[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_bc
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_bc_sxh_2022.rds")
```

## NB

```{r}
df_raw$total <- df_raw$nb
df_raw$total[df_raw$nam == 2019] <- df_raw$m_nb[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_nb[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_nb
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_nb_sxh_2022.rds")
```

## TPTĐ

```{r}
df_raw$total <- df_raw$tptd
df_raw$total[df_raw$nam == 2019] <- df_raw$m_tptd[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_tptd[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_tptd
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_tptd_sxh_2022.rds")
```

## CG

```{r}
df_raw$total <- df_raw$cg
df_raw$total[df_raw$nam == 2019] <- df_raw$m_cg[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_cg[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_cg
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_cg_sxh_2022.rds")
```

## TP

```{r}
df_raw$total <- df_raw$tp
df_raw$total[df_raw$nam == 2019] <- df_raw$m_tp[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_tp[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_tp
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_tphu_sxh_2022.rds")
```

## BTA

```{r}
df_raw$total <- df_raw$bta
df_raw$total[df_raw$nam == 2019] <- df_raw$m_bta[df_raw$nam == 2019]

df_raw$total[df_raw$nam == 2021] <- df_raw$m_bta[df_raw$nam == 2021] 

df_raw$threshold <- df_raw$thr_bta
 
df <- df_raw %>% 
  mutate(outbreak = ifelse(total >= threshold, 1, 0))

stsObj <- with(df, sts(observed = total,
                       state = outbreak,
                       start = c(2016, 1), frequency = 52)
)
disProgObj <- sts2disProg(stsObj)
```

### Phương pháp Farrington (English model)

```{r}
control <- list(b = 5, w = 3, range = 313:364, reweight = T, verbose = F)

farrington <- algo.farrington(disProgObj, control = control)
plot(farrington, main = "Farrington method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(b = 5, w = 3, range = 313:364, reweight = T, weightsTreshold = 2.58,
                thresholdMethod = "nbPlugin")

farringtonF <- farringtonFlexible(stsObj,
                                  control = control)

plot(farringtonF, main = "Farrington Flexible", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp CUSUM

```{r}
control <- list(range = 313:364, k = 1.04, h = 2.26)
cusum <- algo.cusum(disProgObj, control = control) # Original CUSUM
plot(cusum, main = "Original CUSUM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "rossi")
cusum_rossi <- algo.cusum(disProgObj, control = control) # Rossi CUSUM
plot(cusum_rossi, main = "CUSUM Rossi method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "rossi")
cusum_glm_rossi <- algo.cusum(disProgObj, control = control) # GLM Rossi CUSUM
plot(cusum_glm_rossi, main = "CUSUM Rossi fit GLM method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, trans = "pearsonNegBin")
cusum_negbin <- algo.cusum(disProgObj, control = control) # Negbin CUSUM
plot(cusum_negbin, main = "CUSUM NegBin method", xlab = "Epi week", ylab = "Number of Cases")


control <- list(range = 313:364, k = 1.04, h = 2.26, m = "glm", trans = "pearsonNegBin")
cusum_glm_negbin <- algo.cusum(disProgObj, control = control) # GLM Negbin CUSUM
plot(cusum_glm_negbin, main = "CUSUM NegBin fit GLM method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp RKI

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

rki1 <- algo.rki1(disProgObj, control = control)
plot(rki1, main = "RKI 1 method", xlab = "Epi week", ylab = "Number of Cases")

rki2 <- algo.rki2(disProgObj, control = control)
plot(rki2, main = "RKI 2 method", xlab = "Epi week", ylab = "Number of Cases")

# rki3 <- algo.rki3(disProgObj, control = control)
# plot(rki3, main = "RKI 3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Bayesian

```{r}
control <- list(range = 313:364, actY = F,
                b = 5, w = 3)

bayes1 <- algo.bayes1(disProgObj, control = control)
plot(bayes1, main = "Bayes 1 method", xlab = "Epi week", ylab = "Number of Cases")

bayes2 <- algo.bayes2(disProgObj, control = control)
plot(bayes2, main = "Bayes 2 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EARS

```{r}
control <- list(range = 313:364, method = "C1", baseline = 4, alpha = 0.05)
c1 <- earsC(stsObj, control = control)
plot(c1, main = "EARS C1 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C2", baseline = 4, alpha = 0.05)
c2 <- earsC(stsObj, control = control)
plot(c2, main = "EARS C2 method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, method = "C3", baseline = 4, alpha = 0.05)
c3 <- earsC(stsObj, control = control)
plot(c3, main = "EARS C3 method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp Generalized Likelihood Ratio (GLR)

```{r}
control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrnb <- algo.glrnb(disProgObj, control = control)
plot(glrnb, main = "GLR NegBin method", xlab = "Epi week", ylab = "Number of Cases")

control <- list(range = 313:364, c.ARL = 5, dir = "inc")
glrpois <- algo.glrpois(disProgObj, control = control)
plot(glrpois, main = "GLR Poisson method", xlab = "Epi week", ylab = "Number of Cases")
```

### Phương pháp EWMA

```{r}
dff <- filter(df, nam <= 2022 & nam > 2016) 

dff <- dff[,c("nam","tuan","total","threshold")]

dff <- dff %>%
  pivot_wider(
    names_from = nam,     
    values_from = total,
    names_prefix = "y_"
  )

dff_mem <- dff[,c(3,4,5,6,7)] # Lấy dữ liệu 2017 - 2021 (5 năm) 

epi <- memmodel(dff_mem) # Tính theo mem method

plot(epi)

# Lấy threshold_mem = epidemic
dff$threshold_mem <- epi$epidemic.threshold[1]

dff <- dff %>%
  mutate(outbreak = ifelse(y_2022 > threshold, 1, 0),
         outbreak_mem = ifelse(y_2022 > threshold_mem, 1, 0))

dff$outbreak_mem <- ifelse(dff$outbreak_mem == 0,NA,1) #Outbreak MEM

dff$outbreak <- ifelse(dff$outbreak == 0,NA,1) #Outbreak thực tế

ggplot(dff) + 
  geom_col(aes(x = tuan, y = y_2022)) +
  geom_line(aes(x = tuan, y = threshold_mem), size = 1, color = "blue") +
  geom_point(aes(x = tuan, y = outbreak_mem, color = "MEM method"), 
             size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), 
             position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases") +
  scale_color_manual(
      name = "Method", 
      values = c("MEM method" = "red", "Standard" = "green"))

dff$outbreak_mem <- ifelse(is.na(dff$outbreak_mem),0,1)
dff$outbreak <- ifelse(is.na(dff$outbreak),0,1)
```

### Phương pháp Serfling model (Linear model)

```{r}
dfff <- filter(df, nam < 2022)

sm <- lm(total ~ t + sin(2*pi*t/52) + cos(2*pi*t/52), data = dfff)

predict <- predict(sm, newdata = df, interval = "predict")

df$predict <- predict[,3]

df$outbreak_sm <- ifelse(df$total >= df$predict, 1, 0)

df$outbreak_sm <- ifelse(df$outbreak_sm == 0,NA,1)

df$outbreak <- ifelse(df$outbreak == 0,NA,1)

filter(df, nam == 2022) %>% ggplot() +
  geom_col(aes(x = tuan, y = total)) +
  geom_line(aes(x = tuan, y = predict), size = 1) +
  geom_point(aes(x = tuan, y = outbreak_sm, color = "Serfling model"), size = 2, position = position_nudge(y = 2)) +
  geom_point(aes(x = tuan, y = outbreak, color = "Standard"), position = position_nudge(y = -0.5)) +
  labs(x = "Epi week", y = "Number of Cases", title = "Serfling model method") +
  scale_color_manual(
    name = "Method", 
    values = c("Serfling model" = "red", "Standard" = "green"))

df$outbreak_sm <- ifelse(is.na(df$outbreak_sm),0,1)
df$outbreak <- ifelse(is.na(df$outbreak),0,1)
```

### Bảng kết quả

```{r}
m1 <- algo.quality(farrington)
m2 <-algo.quality(farringtonF)
m3 <-algo.quality(cusum)
m4 <-algo.quality(cusum_rossi)
m5 <-algo.quality(cusum_glm_rossi)
m6 <-algo.quality(cusum_negbin)
m7 <-algo.quality(cusum_glm_negbin)
m8 <-algo.quality(rki1)
m9 <-algo.quality(rki2)
m10 <-algo.quality(bayes1)
m11 <-algo.quality(bayes2)
m12 <-algo.quality(glrnb)
m13 <-algo.quality(glrpois)
m14 <-algo.quality(c1)
m15 <-algo.quality(c2)
m16 <-algo.quality(c3)

# EWMA
dff$outbreak <- factor(dff$outbreak, levels = c(0,1), labels = c(0,1))
dff$outbreak_mem <- factor(dff$outbreak_mem, levels = c(0,1), labels = c(0,1))
m17 <- caret::confusionMatrix(dff$outbreak, dff$outbreak_mem)

# SM
cfm_sm <- filter(df, nam == 2022)
cfm_sm$outbreak <- factor(cfm_sm$outbreak, levels = c(0,1), labels = c(0,1))
cfm_sm$outbreak_sm <- factor(cfm_sm$outbreak_sm, levels = c(0,1), labels = c(0,1))
m18 <- caret::confusionMatrix(cfm_sm$outbreak, cfm_sm$outbreak_sm)
```

```{r}
method <- c("Farrington", "FarringtonF", "CUSUM", "CUSUM-Rossi",
            "CUSUM-Rossi fit GLM", "CUSUM-NegBin", "CUSUM-NegBin-fitGLM",
            "RKI1", "RKI2", "Bayes1", "Bayes2", "GLR-NegBin", "GLR-Poisson",
            "EARS C1", "EARS C2", "EARS C3", "EWMA", "Serfling Model")

sens <- c(m1$sens, m2$sens, m3$sens, m4$sens, m5$sens, m6$sens, m7$sens, m8$sens,
          m9$sens, m10$sens, m11$sens, m12$sens, m13$sens, m14$sens, m15$sens,
          m16$sens, m17$byClass["Sensitivity"], m18$byClass["Sensitivity"])

spec <- c(m1$spec, m2$spec, m3$spec, m4$spec, m5$spec, m6$spec, m7$spec, m8$spec,
          m9$spec, m10$spec, m11$spec, m12$spec, m13$spec, m14$spec, m15$spec,
          m16$spec, m17$byClass["Specificity"], m18$byClass["Specificity"])

fpr <- c(1-m1$spec, 1-m2$spec, 1-m3$spec, 1-m4$spec, 1-m5$spec, 1-m6$spec, 
         1-m7$spec, 1-m8$spec, 1-m9$spec, 1-m10$spec, 1-m11$spec, 1-m12$spec,
         1-m13$spec, 1-m14$spec, 1-m15$spec, 1-m16$spec, 
         1-m17$byClass["Specificity"], 1-m18$byClass["Specificity"])

ppv <- c(m1$TP/(m1$TP+m1$FP), m2$TP/(m2$TP+m2$FP), m3$TP/(m3$TP+m3$FP), 
         m4$TP/(m4$TP+m4$FP), m5$TP/(m5$TP+m5$FP), m6$TP/(m6$TP+m6$FP),
         m7$TP/(m7$TP+m7$FP), m8$TP/(m8$TP+m8$FP), m9$TP/(m9$TP+m9$FP),
         m10$TP/(m10$TP+m10$FP), m11$TP/(m11$TP+m11$FP), m12$TP/(m12$TP+m12$FP),
         m13$TP/(m13$TP+m13$FP), m14$TP/(m14$TP+m14$FP), m15$TP/(m15$TP+m15$FP),
         m16$TP/(m16$TP+m16$FP), m17$byClass["Pos Pred Value"], 
         m18$byClass["Pos Pred Value"])

npv <- c(m1$TN/(m1$TN+m1$FN), m2$TN/(m2$TN+m2$FN), m3$TN/(m3$TN+m3$FN), 
         m4$TN/(m4$TN+m4$FN), m5$TN/(m5$TN+m5$FN), m6$TN/(m6$TN+m6$FN),
         m7$TN/(m7$TN+m7$FN), m8$TN/(m8$TN+m8$FN), m9$TN/(m9$TN+m9$FN),
         m10$TN/(m10$TN+m10$FN), m11$TN/(m11$TN+m11$FN), m12$TN/(m12$TN+m12$FN),
         m13$TN/(m13$TN+m13$FN), m14$TN/(m14$TN+m14$FN), m15$TN/(m15$TN+m15$FN),
         m16$TN/(m16$TN+m16$FN), m17$byClass["Neg Pred Value"], 
         m18$byClass["Neg Pred Value"])

tbl <- data.frame(method, spec, sens, fpr, ppv, npv)
saveRDS(tbl, "tbl_bta_sxh_2022.rds")
```